<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理後台 - ACTC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="/components/NewsManagement.js"></script>
</head>
<body class="bg-gray-50" x-data="adminApp()">
    <!-- 強制修改密碼對話框 -->
    <div x-show="showForcePasswordChange" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold mb-4">首次登入 - 請修改密碼</h3>
            <form @submit.prevent="forceChangePassword">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">新密碼</label>
                    <input type="password" x-model="newPassword" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">確認新密碼</label>
                    <input type="password" x-model="confirmPassword" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div class="flex space-x-2">
                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                        確認修改
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 登入表單 -->
    <div x-show="!isLoggedIn && !showForcePasswordChange" class="min-h-screen flex items-center justify-center">
        <div class="max-w-md w-full space-y-8">
            <div class="text-center">
                <h2 class="text-3xl font-bold text-gray-900">管理員登入</h2>
            </div>
            <form @submit.prevent="login" class="mt-8 space-y-6">
                <div>
                    <input x-model="loginForm.username" type="text" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                           placeholder="使用者帳號">
                </div>
                <div>
                    <input x-model="loginForm.password" type="password" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md" 
                           placeholder="密碼">
                </div>
                <div>
                    <button type="submit" :disabled="isLoading"
                            class="w-full bg-orange-600 text-white py-2 px-4 rounded-md hover:bg-orange-700 disabled:opacity-50">
                        <span x-show="!isLoading">登入</span>
                        <span x-show="isLoading">登入中...</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 管理後台 -->
    <div x-show="isLoggedIn && !showForcePasswordChange">
        <!-- 導航列 -->
        <nav class="bg-white shadow-lg">
            <div class="max-w-7xl mx-auto px-4">
                <div class="flex justify-between items-center h-16">
                    <h1 class="text-xl font-bold">ACTC 管理後台</h1>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-600" x-text="`歡迎, ${currentUser.username} (${currentUser.role})`"></span>
                        <button @click="logout" class="bg-red-500 text-white px-4 py-2 rounded text-sm">登出</button>
                    </div>
                </div>
            </div>
        </nav>
        
        <!-- 側邊選單 -->
        <div class="flex">
            <aside class="w-64 bg-gray-800 min-h-screen">
                <nav class="mt-8">
                    <template x-if="currentUser.role === 'admin'">
                        <a @click="currentTab = 'users'" 
                           :class="currentTab === 'users' ? 'bg-gray-700 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'"
                           class="flex items-center px-6 py-3 cursor-pointer">
                            <span>使用者管理</span>
                        </a>
                    </template>
                    <a @click="currentTab = 'news'" 
                       :class="currentTab === 'news' ? 'bg-gray-700 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'"
                       class="flex items-center px-6 py-3 cursor-pointer">
                        <span>最新消息管理</span>
                    </a>
                    <a @click="currentTab = 'events'" 
                       :class="currentTab === 'events' ? 'bg-gray-700 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'"
                       class="flex items-center px-6 py-3 cursor-pointer">
                        <span>活動課程管理</span>
                    </a>
                    <a @click="currentTab = 'corporate-members'" 
                       :class="currentTab === 'corporate-members' ? 'bg-gray-700 text-white' : 'text-gray-300 hover:bg-gray-700 hover:text-white'"
                       class="flex items-center px-6 py-3 cursor-pointer">
                        <span>企業會員管理</span>
                    </a>
                </nav>
            </aside>

            <!-- 主要內容區域 -->
            <main class="flex-1 p-8">
                <!-- 使用者管理 -->
                <div x-show="currentTab === 'users'" x-data="usersTab()">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">使用者管理</h2>
                        <button @click="showCreateModal = true" class="bg-blue-600 text-white px-4 py-2 rounded">
                            新增使用者
                        </button>
                    </div>

                    <!-- 使用者列表 -->
                    <div class="bg-white rounded-lg shadow overflow-hidden">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">使用者名稱</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">電子郵件</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">角色</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">狀態</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">最後登入</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">操作</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <template x-for="user in users" :key="user._id">
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="text-sm font-medium text-gray-900" x-text="user.username"></div>
                                            <div class="text-sm text-gray-500" x-text="user.fullName || '-'"></div>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="user.email || '-'"></td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span :class="user.role === 'admin' ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800'"
                                                  class="px-2 py-1 text-xs font-semibold rounded-full" x-text="user.role"></span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span :class="user.isActive ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                                  class="px-2 py-1 text-xs font-semibold rounded-full" x-text="user.isActive ? '啟用' : '停用'"></span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" 
                                            x-text="user.lastLogin ? new Date(user.lastLogin).toLocaleString() : '-'"></td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                                            <button @click="editUser(user)" class="text-blue-600 hover:text-blue-900">編輯</button>
                                            <button @click="toggleUserStatus(user)" 
                                                    :class="user.isActive ? 'text-red-600 hover:text-red-900' : 'text-green-600 hover:text-green-900'"
                                                    x-text="user.isActive ? '停用' : '啟用'"></button>
                                            <button @click="resetPassword(user)" class="text-yellow-600 hover:text-yellow-900">重設密碼</button>
                                            <button @click="deleteUser(user)" class="text-red-600 hover:text-red-900">刪除</button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>

                    <!-- 新增/編輯使用者 Modal -->
                    <div x-show="showCreateModal || showEditModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
                            <h3 class="text-lg font-semibold mb-4" x-text="showEditModal ? '編輯使用者' : '新增使用者'"></h3>
                            <form @submit.prevent="showEditModal ? updateUser() : createUser()">
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2">使用者名稱</label>
                                    <input type="text" x-model="userForm.username" required 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2">電子郵件</label>
                                    <input type="email" x-model="userForm.email" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2">全名</label>
                                    <input type="text" x-model="userForm.fullName" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                </div>
                                <div class="mb-4">
                                    <label class="block text-sm font-medium mb-2">角色</label>
                                    <select x-model="userForm.role" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                                        <option value="user">一般使用者</option>
                                        <option value="admin">管理員</option>
                                    </select>
                                </div>
                                <div class="flex space-x-2">
                                    <button type="submit" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700">
                                        <span x-text="showEditModal ? '更新' : '創建'"></span>
                                    </button>
                                    <button type="button" @click="closeModal" class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-md hover:bg-gray-400">
                                        取消
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- 最新消息管理 -->
                <div x-show="currentTab === 'news'">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="text-center">
                            <h2 class="text-3xl font-bold text-gray-900 mb-4">最新消息管理</h2>
                            <p class="text-gray-600 mb-8">管理網站的最新消息、文章和公告</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                <!-- 統計卡片 -->
                                <div class="bg-blue-50 p-6 rounded-lg">
                                    <div class="text-3xl font-bold text-blue-600 mb-2" id="newsStatsPublished">-</div>
                                    <div class="text-sm text-gray-600">已發布新聞</div>
                                </div>
                                <div class="bg-yellow-50 p-6 rounded-lg">
                                    <div class="text-3xl font-bold text-yellow-600 mb-2" id="newsStatsDraft">-</div>
                                    <div class="text-sm text-gray-600">草稿新聞</div>
                                </div>
                                <div class="bg-green-50 p-6 rounded-lg">
                                    <div class="text-3xl font-bold text-green-600 mb-2" id="newsStatsViews">-</div>
                                    <div class="text-sm text-gray-600">總瀏覽次數</div>
                                </div>
                            </div>
                            
                            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                                <a href="/admin/news" 
                                   class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition-colors">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                    </svg>
                                    進入新聞管理
                                </a>
                                
                                <button onclick="loadNewsQuickStats()" 
                                        class="inline-flex items-center justify-center px-6 py-3 border border-gray-300 text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    重新載入統計
                                </button>
                            </div>
                            
                            <div class="mt-8 text-left">
                                <h3 class="text-lg font-semibold text-gray-900 mb-4">功能說明</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <h4 class="font-medium text-gray-900 mb-2">📝 內容管理</h4>
                                        <ul class="text-sm text-gray-600 space-y-1">
                                            <li>• 創建和編輯新聞文章</li>
                                            <li>• 上傳圖片和附件檔案</li>
                                            <li>• 嵌入 YouTube/Instagram 影片</li>
                                            <li>• 設定發布時間和狀態</li>
                                        </ul>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <h4 class="font-medium text-gray-900 mb-2">📊 數據追蹤</h4>
                                        <ul class="text-sm text-gray-600 space-y-1">
                                            <li>• Google Analytics 整合</li>
                                            <li>• 瀏覽次數統計</li>
                                            <li>• 用戶互動分析</li>
                                            <li>• 熱門文章追蹤</li>
                                        </ul>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <h4 class="font-medium text-gray-900 mb-2">🔧 批量操作</h4>
                                        <ul class="text-sm text-gray-600 space-y-1">
                                            <li>• 批量發布/設為草稿</li>
                                            <li>• 批量刪除文章</li>
                                            <li>• 標籤管理</li>
                                            <li>• 精選文章設定</li>
                                        </ul>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <h4 class="font-medium text-gray-900 mb-2">🔍 搜尋篩選</h4>
                                        <ul class="text-sm text-gray-600 space-y-1">
                                            <li>• 標題/內容搜尋</li>
                                            <li>• 狀態篩選</li>
                                            <li>• 日期範圍篩選</li>
                                            <li>• 排序功能</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 活動課程管理 -->
                <div x-show="currentTab === 'events'">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="text-center">
                            <h2 class="text-3xl font-bold text-gray-900 mb-4">活動課程管理</h2>
                            <p class="text-gray-600 mb-8">管理活動課程，支援檔案上傳、圖片管理和講師介紹</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                <!-- 統計卡片 -->
                                <div class="bg-blue-50 p-6 rounded-lg">
                                    <div class="text-3xl font-bold text-blue-600 mb-2" id="eventStatsTotal">-</div>
                                    <div class="text-sm text-gray-600">總活動數</div>
                                </div>
                                <div class="bg-green-50 p-6 rounded-lg">
                                    <div class="text-3xl font-bold text-green-600 mb-2" id="eventStatsUpcoming">-</div>
                                    <div class="text-sm text-gray-600">即將到來</div>
                                </div>
                                <div class="bg-purple-50 p-6 rounded-lg">
                                    <div class="text-3xl font-bold text-purple-600 mb-2" id="eventStatsWithFiles">-</div>
                                    <div class="text-sm text-gray-600">有檔案</div>
                                </div>
                            </div>
                            
                            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                                <a href="/admin-events.html" 
                                   class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition-colors">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                                    </svg>
                                    進入活動課程管理
                                </a>

                                <button onclick="loadEventQuickStats()"
                                        class="inline-flex items-center justify-center px-6 py-3 border border-gray-300 text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    重新載入統計
                                </button>
                            </div>
                            
                            <!-- 功能說明 -->
                            <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-gray-900 mb-2">✨ 主要功能</h4>
                                    <ul class="text-sm text-gray-600 space-y-1">
                                        <li>• 新增、編輯、刪除活動課程</li>
                                        <li>• 活動圖片上傳和管理</li>
                                        <li>• 檔案上傳（20MB以下）</li>
                                        <li>• 講師介紹和照片</li>
                                        <li>• 活動狀態管理</li>
                                    </ul>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-gray-900 mb-2">🎛️ 進階功能</h4>
                                    <ul class="text-sm text-gray-600 space-y-1">
                                        <li>• 活動類型分類</li>
                                        <li>• 報名名額管理</li>
                                        <li>• 時間和地點設定</li>
                                        <li>• 標籤和需求管理</li>
                                        <li>• 統計和報表</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 企業會員管理 -->
                <div x-show="currentTab === 'corporate-members'">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="text-center">
                            <h2 class="text-3xl font-bold text-gray-900 mb-4">企業會員管理</h2>
                            <p class="text-gray-600 mb-8">管理企業會員資料，控制前端顯示</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                <!-- 統計卡片 -->
                                <div class="bg-purple-50 p-6 rounded-lg">
                                    <div class="text-3xl font-bold text-purple-600 mb-2" id="memberStatsTotal">-</div>
                                    <div class="text-sm text-gray-600">總企業會員</div>
                                </div>
                                <div class="bg-green-50 p-6 rounded-lg">
                                    <div class="text-3xl font-bold text-green-600 mb-2" id="memberStatsActive">-</div>
                                    <div class="text-sm text-gray-600">啟用會員</div>
                                </div>
                                <div class="bg-blue-50 p-6 rounded-lg">
                                    <div class="text-3xl font-bold text-blue-600 mb-2" id="memberStatsDisplayed">-</div>
                                    <div class="text-sm text-gray-600">前端顯示</div>
                                </div>
                            </div>
                            
                            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                                <a href="/admin/corporate-members" 
                                   class="inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-purple-600 hover:bg-purple-700 transition-colors">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                                    </svg>
                                    進入企業會員管理
                                </a>

                                <button onclick="loadMemberQuickStats()"
                                        class="inline-flex items-center justify-center px-6 py-3 border border-gray-300 text-base font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    重新載入統計
                                </button>
                            </div>
                            
                            <!-- 功能說明 -->
                            <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6 text-left">
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-gray-900 mb-2">✨ 主要功能</h4>
                                    <ul class="text-sm text-gray-600 space-y-1">
                                        <li>• 新增、編輯、刪除企業會員</li>
                                        <li>• 會員類型管理（白金、金級、銀級、銅級）</li>
                                        <li>• 公司Logo上傳</li>
                                        <li>• 聯絡資訊管理</li>
                                        <li>• 顯示順序控制</li>
                                    </ul>
                                </div>
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h4 class="font-semibold text-gray-900 mb-2">🎛️ 顯示控制</h4>
                                    <ul class="text-sm text-gray-600 space-y-1">
                                        <li>• 啟用/停用企業會員</li>
                                        <li>• 前端顯示/隱藏控制</li>
                                        <li>• 批量操作功能</li>
                                        <li>• 會員類型篩選</li>
                                        <li>• 搜尋和排序</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        function adminApp() {
            return {
                isLoggedIn: false,
                isLoading: false,
                currentUser: null,
                currentTab: 'users',
                showForcePasswordChange: false,
                newPassword: '',
                confirmPassword: '',
                loginForm: {
                    username: '',
                    password: ''
                },

                async init() {
                    await this.checkAuth();
                },

                async checkAuth() {
                    const token = localStorage.getItem('adminToken');
                    if (!token) return;

                    try {
                        const response = await fetch('/api/auth/verify', {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.currentUser = data.user;
                            this.isLoggedIn = true;
                            
                            if (data.user.isFirstLogin) {
                                this.showForcePasswordChange = true;
                            }
                        } else {
                            localStorage.removeItem('adminToken');
                        }
                    } catch (error) {
                        console.error('Auth check failed:', error);
                        localStorage.removeItem('adminToken');
                    }
                },

                async login() {
                    this.isLoading = true;
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                            body: JSON.stringify(this.loginForm)
                });

                        const data = await response.json();

                if (response.ok) {
                            localStorage.setItem('adminToken', data.token);
                            this.currentUser = data.user;
                            this.isLoggedIn = true;
                            
                            if (data.user.isFirstLogin) {
                                this.showForcePasswordChange = true;
                            }
                            
                            this.loginForm = { username: '', password: '' };
                } else {
                            alert('登入失敗：' + data.message);
                }
            } catch (error) {
                alert('登入錯誤：' + error.message);
                    } finally {
                        this.isLoading = false;
                    }
                },

                async forceChangePassword() {
                    if (this.newPassword !== this.confirmPassword) {
                        alert('密碼確認不符');
                        return;
                    }

                    try {
                        const response = await fetch('/api/auth/force-change-password', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                            },
                            body: JSON.stringify({
                                newPassword: this.newPassword
                            })
                        });

                        if (response.ok) {
                            this.showForcePasswordChange = false;
                            this.currentUser.isFirstLogin = false;
                            this.newPassword = '';
                            this.confirmPassword = '';
                            alert('密碼修改成功！');
                        } else {
                            const data = await response.json();
                            alert('密碼修改失敗：' + data.message);
                        }
                    } catch (error) {
                        alert('密碼修改錯誤：' + error.message);
                    }
                },

                logout() {
                    localStorage.removeItem('adminToken');
                    this.isLoggedIn = false;
                    this.currentUser = null;
                    this.currentTab = 'users';
                }
            }
        }

        function usersTab() {
            return {
                users: [],
                showCreateModal: false,
                showEditModal: false,
                editingUser: null,
                userForm: {
                    username: '',
                    email: '',
                    fullName: '',
                    role: 'user'
                },

                async init() {
                    await this.loadUsers();
                },

                async loadUsers() {
                    try {
                        const response = await fetch('/api/users', {
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                            }
                        });

                        if (response.ok) {
                            const data = await response.json();
                            this.users = data.users;
                        }
                    } catch (error) {
                        console.error('Load users failed:', error);
                    }
                },

                async createUser() {
                    try {
                        const response = await fetch('/api/users', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                            },
                            body: JSON.stringify(this.userForm)
                        });

                        const data = await response.json();

                        if (response.ok) {
                            await this.loadUsers();
                            this.closeModal();
                            alert('使用者創建成功！預設密碼為 "user"');
                        } else {
                            alert('創建失敗：' + data.message);
                        }
                    } catch (error) {
                        alert('創建錯誤：' + error.message);
                    }
                },

                editUser(user) {
                    this.editingUser = user;
                    this.userForm = {
                        username: user.username,
                        email: user.email || '',
                        fullName: user.fullName || '',
                        role: user.role
                    };
                    this.showEditModal = true;
                },

                async updateUser() {
                    try {
                        const response = await fetch(`/api/users/${this.editingUser._id}`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                            },
                            body: JSON.stringify(this.userForm)
                        });

                        const data = await response.json();

                        if (response.ok) {
                            await this.loadUsers();
                            this.closeModal();
                            alert('使用者更新成功！');
            } else {
                            alert('更新失敗：' + data.message);
                        }
                    } catch (error) {
                        alert('更新錯誤：' + error.message);
                    }
                },

                async toggleUserStatus(user) {
                    if (!confirm(`確定要${user.isActive ? '停用' : '啟用'}此使用者嗎？`)) return;

                    try {
                        const response = await fetch(`/api/users/${user._id}/toggle-status`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                            }
                        });

                        if (response.ok) {
                            await this.loadUsers();
                        }
                    } catch (error) {
                        alert('操作失敗：' + error.message);
                    }
                },

                async resetPassword(user) {
                    if (!confirm('確定要重設此使用者的密碼嗎？密碼將重設為 "user"')) return;

                    try {
                        const response = await fetch(`/api/users/${user._id}/reset-password`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                            }
                        });

                        if (response.ok) {
                            alert('密碼重設成功！新密碼為 "user"');
                        }
                    } catch (error) {
                        alert('密碼重設失敗：' + error.message);
                    }
                },

                async deleteUser(user) {
                    if (!confirm(`確定要刪除使用者 "${user.username}" 嗎？此操作無法復原！`)) return;

                    try {
                        const response = await fetch(`/api/users/${user._id}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                            }
                        });

                        if (response.ok) {
                            await this.loadUsers();
                            alert('使用者刪除成功！');
                        }
                    } catch (error) {
                        alert('刪除失敗：' + error.message);
                    }
                },

                closeModal() {
                    this.showCreateModal = false;
                    this.showEditModal = false;
                    this.editingUser = null;
                    this.userForm = {
                        username: '',
                        email: '',
                        fullName: '',
                        role: 'user'
                    };
                }
            }
        }
        // 載入新聞快速統計
        async function loadNewsQuickStats() {
            try {
                const token = localStorage.getItem('adminToken');
                if (!token) return;

                const response = await fetch('/api/news/admin?limit=1', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const stats = data.stats || {};
                    
                    document.getElementById('newsStatsPublished').textContent = stats.published?.count || 0;
                    document.getElementById('newsStatsDraft').textContent = stats.draft?.count || 0;
                    document.getElementById('newsStatsViews').textContent = (stats.published?.totalViews || 0) + (stats.draft?.totalViews || 0);
                } else {
                    console.error('Failed to load news stats');
                }
            } catch (error) {
                console.error('Error loading news stats:', error);
            }
        }

        // 載入企業會員快速統計
        async function loadMemberQuickStats() {
            try {
                const token = localStorage.getItem('adminToken');
                if (!token) return;

                const response = await fetch('/api/corporate-members/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const stats = data.stats || {};
                    
                    document.getElementById('memberStatsTotal').textContent = stats.total || 0;
                    document.getElementById('memberStatsActive').textContent = stats.active || 0;
                    document.getElementById('memberStatsDisplayed').textContent = stats.displayed || 0;
                } else {
                    console.error('Failed to load member stats');
                }
            } catch (error) {
                console.error('Error loading member stats:', error);
            }
        }

        // 載入活動課程快速統計
        async function loadEventQuickStats() {
            try {
                const token = localStorage.getItem('adminToken');
                if (!token) return;

                const response = await fetch('/api/events/stats', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    document.getElementById('eventStatsTotal').textContent = data.totalEvents || 0;
                    document.getElementById('eventStatsUpcoming').textContent = data.upcomingEvents || 0;
                    document.getElementById('eventStatsWithFiles').textContent = data.eventsWithFiles || 0;
                } else {
                    console.error('Failed to load event stats');
                }
            } catch (error) {
                console.error('Error loading event stats:', error);
            }
        }

        // 頁面載入時自動載入統計
        document.addEventListener('DOMContentLoaded', function() {
            // 延遲載入統計，確保用戶已登入
            setTimeout(loadNewsQuickStats, 2000);
            setTimeout(loadMemberQuickStats, 2500);
            setTimeout(loadEventQuickStats, 3000);
        });
    </script>
</body>
</html>